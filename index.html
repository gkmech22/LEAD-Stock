<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management System</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .menu { margin-bottom: 20px; }
        .form-group { margin: 10px 0; }
        label { display: inline-block; width: 120px; }
        button { margin-right: 10px; }
        #result { margin-top: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://your-supabase-project-url.supabase.co';
        const supabaseKey = 'your-supabase-anon-key';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let orderCounter = 1;

        // Order and Device models (simplified as JS objects)
        class Order {
            constructor(orderType, salesOrder, dealId, nucleusId, schoolName, product, model, quantity, sdCardSize, profileId, location, warehouse) {
                this.id = `ORD-${String(orderCounter++).padStart(6, '0')}`;
                this.orderType = orderType;
                this.salesOrder = salesOrder;
                this.dealId = dealId;
                this.nucleusId = nucleusId;
                this.schoolName = schoolName;
                this.product = product;
                this.model = model;
                this.quantity = quantity;
                this.sdCardSize = sdCardSize;
                this.profileId = profileId;
                this.location = location;
                this.warehouse = warehouse;
                this.createdAt = new Date().toISOString();
                this.deviceNumbers = this.generateDeviceNumbers();
            }

            generateDeviceNumbers() {
                const prefix = this.generateDevicePrefix();
                return Array.from({ length: this.quantity }, (_, i) => `${prefix}${String(i + 1).padStart(4, '0')}`);
            }

            generateDevicePrefix() {
                let prefix = '';
                switch (this.orderType.toLowerCase()) {
                    case 'new': prefix += 'NEW-'; break;
                    case 'refurbish': prefix += 'REF-'; break;
                    case 'replace': prefix += 'RPL-'; break;
                    default: prefix += 'ORD-';
                }
                prefix += (this.product?.substring(0, 3) || '') + (this.model?.substring(0, 2) || '') + '-';
                return prefix.toUpperCase();
            }
        }

        class Device {
            constructor(deviceNumber, order) {
                this.deviceNumber = deviceNumber;
                this.orderId = order.id;
                this.orderType = order.orderType;
                this.salesOrder = order.salesOrder;
                this.dealId = order.dealId;
                this.nucleusId = order.nucleusId;
                this.schoolName = order.schoolName;
                this.product = order.product;
                this.model = order.model;
                this.quantity = order.quantity;
                this.sdCardSize = order.sdCardSize;
                this.profileId = order.profileId;
                this.location = order.location;
                this.warehouse = order.warehouse;
                this.createdAt = order.createdAt;
            }
        }

        // Menu functions
        async function createNewOrder() {
            const form = document.createElement('form');
            form.innerHTML = `
                <div class="form-group"><label>Order Type:</label><input type="text" id="orderType" required></div>
                <div class="form-group"><label>Sales Order:</label><input type="text" id="salesOrder" required></div>
                <div class="form-group"><label>Deal ID:</label><input type="text" id="dealId"></div>
                <div class="form-group"><label>Nucleus ID:</label><input type="text" id="nucleusId"></div>
                <div class="form-group"><label>School Name:</label><input type="text" id="schoolName"></div>
                <div class="form-group"><label>Product:</label><input type="text" id="product"></div>
                <div class="form-group"><label>Model:</label><input type="text" id="model"></div>
                <div class="form-group"><label>Quantity:</label><input type="number" id="quantity" required></div>
                <div class="form-group"><label>SD Card Size:</label><input type="text" id="sdCardSize"></div>
                <div class="form-group"><label>Profile ID:</label><input type="text" id="profileId"></div>
                <div class="form-group"><label>Location:</label><input type="text" id="location"></div>
                <div class="form-group"><label>Warehouse:</label><input type="text" id="warehouse" required></div>
                <button type="submit">Submit</button>
            `;
            document.getElementById('result').innerHTML = '';
            document.getElementById('result').appendChild(form);

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const order = new Order(
                    document.getElementById('orderType').value,
                    document.getElementById('salesOrder').value,
                    document.getElementById('dealId').value,
                    document.getElementById('nucleusId').value,
                    document.getElementById('schoolName').value,
                    document.getElementById('product').value,
                    document.getElementById('model').value,
                    parseInt(document.getElementById('quantity').value),
                    document.getElementById('sdCardSize').value,
                    document.getElementById('profileId').value,
                    document.getElementById('location').value,
                    document.getElementById('warehouse').value
                );

                const { data, error } = await supabase.from('orders').insert([order]);
                if (error) {
                    document.getElementById('result').innerText = `Error: ${error.message}`;
                    return;
                }

                order.deviceNumbers.forEach(deviceNumber => {
                    supabase.from('devices').insert([new Device(deviceNumber, order)]);
                });

                document.getElementById('result').innerText = `Order Created: ${JSON.stringify(order)}`;
                form.remove();
            });
        }

        async function searchOrders() {
            const searchTerm = prompt('Enter search term (Sales Order, Deal ID, etc.):');
            if (!searchTerm) return;

            const { data, error } = await supabase.from('orders').select('*').ilike('salesOrder', `%${searchTerm}%`);
            if (error) {
                document.getElementById('result').innerText = `Error: ${error.message}`;
                return;
            }
            displayOrders(data);
        }

        async function viewAllDevices() {
            const { data, error } = await supabase.from('devices').select('*').order('createdAt', { ascending: false });
            if (error) {
                document.getElementById('result').innerText = `Error: ${error.message}`;
                return;
            }
            displayDevices(data);
        }

        async function searchDevices() {
            const searchTerm = prompt('Enter search term (Device Number, Sales Order, etc.):');
            if (!searchTerm) return;

            const { data, error } = await supabase.from('devices').select('*').ilike('deviceNumber', `%${searchTerm}%`);
            if (error) {
                document.getElementById('result').innerText = `Error: ${error.message}`;
                return;
            }
            displayDevices(data);
        }

        function exportCSV() {
            supabase.from('devices').select('*').then(({ data, error }) => {
                if (error) {
                    document.getElementById('result').innerText = `Error: ${error.message}`;
                    return;
                }
                const csv = [
                    'Created At,Order Type,Order ID,Sales Order,Deal ID,Device Number,Quantity,Product,Warehouse',
                    ...data.map(d => `${d.createdAt},${d.orderType},${d.orderId},${d.salesOrder},${d.dealId},${d.deviceNumber},${d.quantity},${d.product},${d.warehouse}`)
                ].join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `devices_export_${new Date().toISOString().replace(/[:.-]/g, '')}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                document.getElementById('result').innerText = 'CSV exported successfully';
            });
        }

        // Display functions
        function displayOrders(orders) {
            const table = document.createElement('table');
            table.innerHTML = `
                <tr><th>ID</th><th>Type</th><th>Sales Order</th><th>Quantity</th><th>Warehouse</th></tr>
                ${orders.map(o => `<tr><td>${o.id}</td><td>${o.orderType}</td><td>${o.salesOrder}</td><td>${o.quantity}</td><td>${o.warehouse}</td></tr>`).join('')}
            `;
            document.getElementById('result').innerHTML = '';
            document.getElementById('result').appendChild(table);
        }

        function displayDevices(devices) {
            const table = document.createElement('table');
            table.innerHTML = `
                <tr><th>Created At</th><th>Order Type</th><th>Order ID</th><th>Sales Order</th><th>Device Number</th><th>Quantity</th><th>Product</th><th>Warehouse</th></tr>
                ${devices.map(d => `<tr><td>${d.createdAt}</td><td>${d.orderType}</td><td>${d.orderId}</td><td>${d.salesOrder}</td><td>${d.deviceNumber}</td><td>${d.quantity}</td><td>${d.product}</td><td>${d.warehouse}</td></tr>`).join('')}
            `;
            document.getElementById('result').innerHTML = '';
            document.getElementById('result').appendChild(table);
        }

        // Menu initialization
        document.addEventListener('DOMContentLoaded', () => {
            const menu = document.createElement('div');
            menu.className = 'menu';
            menu.innerHTML = `
                <button onclick="createNewOrder()">1. Create New Order</button>
                <button onclick="searchOrders()">2. Search Orders</button>
                <button onclick="viewAllDevices()">3. View All Devices</button>
                <button onclick="searchDevices()">4. Search Devices</button>
                <button onclick="exportCSV()">5. Export CSV</button>
                <button onclick="alert('Feature not implemented')">6. View Warehouse Summary</button>
                <button onclick="alert('Feature not implemented')">7. View Orders by Warehouse</button>
                <button onclick="window.close()">8. Exit</button>
            `;
            document.body.insertBefore(menu, document.getElementById('result'));
        });
    </script>
</head>
<body>
    <h1>Order Management System</h1>
    <div id="result"></div>
</body>
</html>
